---
title: "Reproducible Research: Course Project 1"
author: "Nikita Pavlov"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output: html_document
---

##A. Preparing data for analysis
```{r setup, echo=TRUE, message=FALSE, warning=FALSE}
# Global options: code must be visible for peer grading
knitr::opts_chunk$set(echo = TRUE)

# We'll use base R + ggplot2 for data visualisation
library(ggplot2)

# The repo includes activity.csv
activity <- read.csv("activity.csv", stringsAsFactors = FALSE)

# Ensure date is Date type
activity$date <- as.Date(activity$date)

# Check structure
str(activity)
summary(activity)

## B. What is mean total number of steps taken per day?
# For this part we ignore missing values (NA) because of the requirements of the assignment and because this allows us to establish a clean baseline before we address the issue of missing data later

# Total number of steps per day
steps_per_day <- aggregate(steps ~ date, data = activity, FUN = sum, na.rm = TRUE)
head(steps_per_day)

# Historgram of total steps per day
ggplot(steps_per_day, aes(x = steps)) +
  geom_histogram(binwidth = 1000) +
  labs(
    title = "Histogram of total steps per day (NA removed)",
    x = "Total steps per day",
    y = "Frequency"
  )
# Mean and median total steps per day
mean_steps <- mean(steps_per_day$steps)
median_steps <- median(steps_per_day$steps)

mean_steps
median_steps

## C. What is the average daily activity pattern?
# 1) Time series plot of average steps by 5-minute interval

avg_by_interval <- aggregate(steps ~ interval, data = activity, FUN = mean, na.rm = TRUE)
head(avg_by_interval)

plot(
  avg_by_interval$interval,
  avg_by_interval$steps,
  type = "l",
  xlab = "5-minute interval",
  ylab = "Average number of steps",
  main = "Average daily activity pattern"
)

# 2) 5-minute interval with maximum average steps
max_row <- avg_by_interval[which.max(avg_by_interval$steps), ]
max_row

## D. Imputing missing values

# 1) Total number of missing values in the dataset
num_missing <- sum(is.na(activity$steps))
num_missing

# 2) Strategy for filling missing values
# We will impute missing steps values using the mean steps for that 5-minute interval (averaged across all days).

# 3) Create a new dataset with missing values filled in
# Create a lookup table: mean steps per interval (computed earlier as avg_by_interval)
interval_means <- avg_by_interval
names(interval_means)[2] <- "interval_mean"

# Merge to bring in interval mean for each row
activity_imputed <- merge(activity, interval_means, by = "interval", all.x = TRUE)
activity_imputed <- activity_imputed[order(activity_imputed$date, activity_imputed$interval), ]

# Impute: replace NA steps with interval mean
na_idx <- is.na(activity_imputed$steps)
activity_imputed$steps[na_idx] <- activity_imputed$interval_mean[na_idx]

# Clean up helper column if you want
activity_imputed$interval_mean <- NULL

# Check that no NAs remain
sum(is.na(activity_imputed$steps))

# 4) Histogram + mean/median of total steps per day after imputation

steps_per_day_imputed <- aggregate(steps ~ date, data = activity_imputed, FUN = sum)
head(steps_per_day_imputed)

ggplot(steps_per_day_imputed, aes(x = steps)) +
  geom_histogram(binwidth = 1000) +
  labs(
    title = "Histogram of total steps per day (after imputing missing values)",
    x = "Total steps per day",
    y = "Frequency"
  )

mean_steps_imputed <- mean(steps_per_day_imputed$steps)
median_steps_imputed <- median(steps_per_day_imputed$steps)

mean_steps_imputed
median_steps_imputed

# After imputing missing values using the mean number of steps for each 5-minute interval, the mean and median total number of steps per day are identical. This occurs because the imputation strategy smooths daily totals and produces a more symmetric distribution of total daily steps compared to the original data with missing values.

# Impact of imputation (brief):
# Compare the mean/median before vs after imputation; The mean total number of steps per day remains essentially unchanged after imputation, while the median increases slightly. This occurs because missing values are replaced with average interval-level activity, which preserves the overall mean but reduces the impact of incomplete days on the distribution, leading to a more symmetric set of daily totals.

## E. Are there differences in activity patterns between weekdays and weekends?

# 1) Create weekday/weekend factor variable
activity_imputed$day_type <- ifelse(
  weekdays(activity_imputed$date) %in% c("Saturday", "Sunday"),
  "weekend",
  "weekday"
)
activity_imputed$day_type <- factor(activity_imputed$day_type, levels = c("weekday", "weekend"))

table(activity_imputed$day_type)

# 2) Panel plot comparing average steps by interval for weekdays vs weekends

# Compute average steps per interval separately for weekday and weekend:
avg_interval_daytype <- aggregate(steps ~ interval + day_type, data = activity_imputed, FUN = mean)
head(avg_interval_daytype)
# Panel plot (two panels) using ggplot:
ggplot(avg_interval_daytype, aes(x = interval, y = steps)) +
  geom_line() +
  facet_wrap(~ day_type, ncol = 1) +
  labs(
    title = "Average steps per 5-minute interval: Weekdays vs Weekends",
    x = "5-minute interval",
    y = "Average number of steps"
  )
